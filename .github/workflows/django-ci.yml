name: Django CI

on:
    push:
        branches:
            - main
            - 'release/*'
    pull_request:
        branches:
            - main
            - 'release/*'

jobs:
    test:
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:12
                env:
                    POSTGRES_DB: testdb
                    POSTGRES_USER: testuser
                    POSTGRES_PASSWORD: testpassword
                ports:
                    - 5432:5432
                options: >-
          --health-cmd="pg_isready -U testuser"
            --health-interval=10s
            --health-timeout=5s
            --health-retries=5

        steps:
      # Checkout the code
            - name: Checkout code
              uses: actions/checkout@v2

      # Set up Python
            - name: Set up Python
              uses: actions/setup-python@v2
              with:
                  python-version: '3.8'

      # Install dependencies
            - name: Install dependencies
              run: |
          python -m pip install --upgrade pip
            pip install -r requirements.txt

      # Set up the database (PostgreSQL in this case)
            - name: Set up database
              run: |
          python manage.py migrate
            python manage.py createcachetable

      # Run tests
            - name: Run tests
              run: |
          python manage.py test
